<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Portal Congreso</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    
    <style>
        .admin-container {
            min-height: 100vh;
            background: #f8f9fa;
        }
        
        .stats-card {
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-3px);
        }
        
        .assignment-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 1rem;
        }
        
        .btn-assign {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            color: white;
            font-weight: 600;
        }
        
        .btn-assign:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        
        /* Estilos para los contadores de resultados */
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .result-item:last-child { border-bottom: none; }
    </style>
</head>
<body class="admin-container">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">
                üéì Congreso Estudiantil de Laboratorios de Ingenier√≠a Qu√≠mica - Admin
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">üë®‚Äçüíº Administrador</span>
                <a class="nav-link" href="#" onclick="logout()">Cerrar Sesi√≥n</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3 mb-4">
                <div class="card stats-card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">üìä Navegaci√≥n</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <!-- Bot√≥n para la secci√≥n de dictamen -->
                            <button class="btn btn-outline-success fw-bold mb-2" onclick="showSection('ready')">
                                ‚úÖ Por Dictaminar <span id="readyBadge" class="badge bg-danger rounded-pill d-none">0</span>
                            </button>

                            <button class="btn btn-outline-primary active" onclick="showSection('assignments')">
                                üìã Asignaciones
                            </button>
                            <button class="btn btn-outline-secondary" onclick="showSection('works')">
                                üìù Trabajos Pendientes
                            </button>
                            <button class="btn btn-outline-secondary" onclick="showSection('evaluators')">
                                üë®‚Äçüè´ Evaluadores
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Panel de Resultados (NUEVO) -->
                <div class="card stats-card mt-3">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">üìà Resultados Finales</h5>
                    </div>
                    <div class="card-body">
                        <div class="result-item">
                            <span>üé§ Ponencia (Oral):</span>
                            <strong id="countOral" class="text-primary">0</strong>
                        </div>
                        <div class="result-item">
                            <span>üìä Cartel (P√≥ster):</span>
                            <strong id="countPoster" class="text-success">0</strong>
                        </div>
                        <div class="result-item">
                            <span>‚ùå Rechazados:</span>
                            <strong id="countRejected" class="text-danger">0</strong>
                        </div>
                    </div>
                </div>
                
                <!-- Panel de Acciones R√°pidas -->
                <div class="card stats-card mt-3">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">‚ö° Acciones R√°pidas</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-assign" onclick="assignAllPendingWorks()">
                                üéØ Asignar Pendientes
                            </button>
                            <button class="btn btn-outline-info" onclick="loadAdminDashboard()">
                                üîÑ Recargar Datos
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Contenido Principal -->
            <div class="col-lg-9">
                
                <!-- Secci√≥n de Asignaciones (Principal) -->
                <div id="assignmentsSection">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Gesti√≥n de Asignaciones</h2>
                        <div>
                            <button class="btn btn-outline-success me-2" onclick="assignAllPendingWorks()">
                                üéØ Asignar Pendientes
                            </button>
                            <button class="btn btn-outline-primary" onclick="loadAdminDashboard()">
                                üîÑ Actualizar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Estad√≠sticas Generales -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card stats-card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4 id="totalWorks">0</h4>
                                    <small>Total Trabajos</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stats-card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h4 id="pendingWorks">0</h4>
                                    <small>Pendientes Asignar</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stats-card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4 id="assignedWorks">0</h4>
                                    <small>En Revisi√≥n</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stats-card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4 id="completedWorks">0</h4>
                                    <small>Dictaminados</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de Asignaciones -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">üìã Asignaciones Recientes</h5>
                        </div>
                        <div class="card-body">
                            <div id="assignmentsList">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2">Cargando...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NUEVA SECCI√ìN: LISTOS PARA DICTAMEN -->
                <div id="readySection" class="d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="text-success">‚úÖ Trabajos Listos para Dictamen</h2>
                        <!-- NUEVO BOT√ìN PARA DICTAMINAR TODOS -->
                        <button class="btn btn-success fw-bold px-4 shadow" onclick="finalizeAllReadyWorks()">
                            üöÄ Dictaminar y Notificar TODOS
                        </button>
                    </div>

                    <div class="alert alert-info border-info">
                        <strong>‚ÑπÔ∏è Importante:</strong> Estos trabajos ya tienen las 3 evaluaciones completas. Al dictaminar, se calcular√° el promedio, se asignar√° la modalidad y se enviar√° el correo autom√°ticamente.
                    </div>
                    
                    <div id="readyWorksList">
                        <!-- Aqu√≠ se cargar√°n los trabajos listos -->
                    </div>
                </div>
                
                <!-- Secci√≥n de Trabajos Pendientes -->
                <div id="worksSection" class="d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Trabajos Pendientes de Asignaci√≥n</h2>
                        <button class="btn btn-success" onclick="assignAllPendingWorks()">
                            üéØ Asignar Todos
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div id="pendingWorksList">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2">Cargando...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Secci√≥n de Evaluadores -->
                <div id="evaluatorsSection" class="d-none">
                    <h2>Gesti√≥n de Evaluadores</h2>
                    <div class="card">
                        <div class="card-body">
                            <div id="evaluatorsList">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2">Cargando...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Progreso -->
    <div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="progressModalTitle">Procesando...</h5>
                </div>
                <div class="modal-body">
                    <div class="progress mb-3">
                        <div id="assignmentProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                    </div>
                    <p id="progressMessage" class="mb-0 text-center">Por favor espera...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/evaluation-assignment.js"></script>

    <script>
        // Variables globales
        let currentSection = 'assignments';
        let allWorks = [];
        let pendingWorks = [];
        let readyWorksCache = []; // Para guardar los listos para dictaminar
        let allAssignmentsCache = [];
        let assignmentSystem = new EvaluationAssignment();
        let progressModal = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
            checkAdminAuth();
        });
        
        async function checkAdminAuth() {
            const session = await window.apiClient.checkAuth();
            if (!session) return window.location.href = 'login.html';
            
            const profile = await window.apiClient.getUserProfile(session.user.id);
            if (!profile || profile.user_type !== 'admin') {
                alert('‚ùå No tienes permisos de administrador');
                return window.location.href = 'student-dashboard.html';
            }
            loadAdminDashboard();
        }
        
        async function loadAdminDashboard() {
            try {
                // Cargar datos
                const [works, assignments, evaluators] = await Promise.all([
                    window.apiClient.getAllWorks(),
                    window.apiClient.getAssignments(),
                    window.apiClient.getEvaluators()
                ]);

                allWorks = works;
                pendingWorks = works.filter(w => w.status === 'pending');
                allAssignmentsCache = assignments;

                updateStatistics(); // Actualiza contadores del sidebar
                displayPendingWorks();
                displayAllAssignments(assignments);
                displayEvaluators(evaluators);
                calculateReadyWorks(); // Calcula la lista de dictamen

            } catch (error) {
                console.error(error);
                alert('Error: ' + error.message);
            }
        }

        // --- L√ìGICA DE LISTOS PARA DICTAMEN ---

        function calculateReadyWorks() {
            const container = document.getElementById('readyWorksList');
            const badge = document.getElementById('readyBadge');
            
            // L√≥gica: Status "under_review" Y tener 3 asignaciones completadas
            readyWorksCache = allWorks.filter(work => {
                if (work.status !== 'under_review') return false; 
                const workAssignments = allAssignmentsCache.filter(a => a.work_id === work.id);
                const completed = workAssignments.filter(a => a.status === 'completed').length;
                return workAssignments.length >= 3 && completed === workAssignments.length;
            });

            // Actualizar badge en bot√≥n del sidebar
            if (readyWorksCache.length > 0) {
                badge.textContent = readyWorksCache.length;
                badge.classList.remove('d-none');
            } else {
                badge.classList.add('d-none');
            }

            if (readyWorksCache.length === 0) {
                container.innerHTML = '<div class="alert alert-light text-center py-4">No hay trabajos listos para dictaminar.</div>';
                return;
            }

            container.innerHTML = readyWorksCache.map(w => `
                <div class="card mb-3 border-success assignment-card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="text-success mb-1">${w.title}</h5>
                                <p class="mb-0">Estudiante: <strong>${w.student_name}</strong></p>
                                <small class="text-muted">‚úÖ 3 Jueces completaron la evaluaci√≥n</small>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-outline-success btn-sm fw-bold" onclick="notifyStudent('${w.id}')">
                                    üìß Notificar Individualmente
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

       // --- FUNCI√ìN ACTUALIZADA: DICTAMEN MASIVO INTELIGENTE ---
        async function finalizeAllReadyWorks() {
            // Verificar si hay trabajos listos (readyWorksCache se calcula en calculateReadyWorks)
            if (readyWorksCache.length === 0) return alert('No hay trabajos listos (con 3 evaluaciones) para procesar.');

            const mensaje = `‚ö†Ô∏è DICTAMEN FINAL CON REGLA DE CUPO ‚ö†Ô∏è\n\n` +
                            `Vas a procesar ${readyWorksCache.length} trabajos.\n` +
                            `- Se calcular√°n los promedios.\n` +
                            `- Se seleccionar√°n los TOP 2 mejores promedios de CADA SEMESTRE para Ponencia.\n` +
                            `- El resto de ponencias se mover√°n a P√≥ster.\n` +
                            `- Se enviar√°n los correos autom√°ticamente.\n\n` +
                            `¬øEst√°s seguro de continuar?`;

            if (!confirm(mensaje)) return;

            progressModal.show();
            document.getElementById('progressMessage').textContent = "Calculando rankings y enviando correos... Esto puede tardar unos segundos.";
            
            try {
                // Llamada √∫nica al backend que hace todo el proceso
                const result = await window.apiClient.batchFinalize();
                
                progressModal.hide();
                
                if (result.success) {
                    alert(`‚úÖ Proceso finalizado exitosamente.\n\nSe han dictaminado ${result.count} trabajos aplicando las reglas de semestre.`);
                    loadAdminDashboard(); // Recargar datos
                } else {
                    throw new Error(result.error || 'Error desconocido');
                }

            } catch (e) {
                progressModal.hide();
                console.error(e);
                alert('‚ùå Ocurri√≥ un error: ' + e.message);
            }
        }


        // --- CONTADORES DEL SIDEBAR (NUEVO) ---
        function updateStatistics() {
            // Stats generales
            document.getElementById('totalWorks').textContent = allWorks.length;
            document.getElementById('pendingWorks').textContent = pendingWorks.length;
            document.getElementById('assignedWorks').textContent = allWorks.filter(w => w.status === 'under_review').length;
            const done = allWorks.filter(w => ['accepted_oral', 'accepted_poster', 'rejected'].includes(w.status)).length;
            document.getElementById('completedWorks').textContent = done;

            // Stats de Resultados (Sidebar)
            const oral = allWorks.filter(w => w.status === 'accepted_oral').length;
            const poster = allWorks.filter(w => w.status === 'accepted_poster').length;
            const rejected = allWorks.filter(w => w.status === 'rejected').length;

            document.getElementById('countOral').textContent = oral;
            document.getElementById('countPoster').textContent = poster;
            document.getElementById('countRejected').textContent = rejected;
        }

        // --- ACCIONES INDIVIDUALES ---

        async function notifyStudent(workId) {
            if(!confirm('¬øFinalizar y notificar este trabajo individualmente?')) return;
            
            const btn = event.target;
            btn.disabled = true; btn.innerHTML = '‚è≥';

            try {
                const result = await window.apiClient.finalizeAndNotify(workId);
                if (result.success) {
                    alert(`‚úÖ Listo. Resultado: ${result.status}`);
                    loadAdminDashboard();
                } else throw new Error(result.error);
            } catch (e) {
                alert('Error: ' + e.message);
                btn.disabled = false; btn.innerHTML = 'üìß Notificar Individualmente';
            }
        }

        async function assignAllPendingWorks() {
            if (pendingWorks.length === 0) return alert('No hay trabajos pendientes.');
            progressModal.show();
            document.getElementById('progressMessage').textContent = "Asignando trabajos...";
            
            let count = 0;
            for (const work of pendingWorks) {
                const res = await assignmentSystem.assignWorksToEvaluators(work.id, 3);
                if (res.success) count++;
            }
            progressModal.hide();
            alert(`Asignados ${count} trabajos.`);
            loadAdminDashboard();
        }
        
        async function assignSingleWork(workId) {
            if (!confirm('¬øAsignar a 3 jueces aleatorios?')) return;
            const res = await assignmentSystem.assignWorksToEvaluators(workId, 3);
            if (res.success) { alert('‚úÖ Asignado'); loadAdminDashboard(); }
            else alert('Error: ' + res.error);
        }

        // --- RENDERIZADO B√ÅSICO ---

        function displayPendingWorks() {
            const container = document.getElementById('pendingWorksList');
            if (!pendingWorks.length) return container.innerHTML = '<p class="text-muted text-center py-4">No hay trabajos pendientes</p>';
            
            container.innerHTML = pendingWorks.map(w => `
                <div class="assignment-card card mb-3 border-warning">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-9">
                                <h6 class="text-primary mb-1">${w.title}</h6>
                                <small>Estudiante: ${w.student_name} | Modalidad: ${w.modality}</small>
                            </div>
                            <div class="col-md-3 text-end">
                                <button class="btn btn-sm btn-success" onclick="assignSingleWork('${w.id}')">üéØ Asignar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displayAllAssignments(assignments) {
            const container = document.getElementById('assignmentsList');
            if (!assignments.length) return container.innerHTML = '<p class="text-center text-muted">Sin asignaciones</p>';
            
            container.innerHTML = assignments.map(a => `
                <div class="assignment-card card mb-2">
                    <div class="card-body py-2">
                        <div class="row">
                            <div class="col-md-6"><strong>${a.works?.title}</strong><br><small>Juez: ${a.user_profiles?.name}</small></div>
                            <div class="col-md-3"><span class="badge bg-${a.status==='completed'?'success':'warning'}">${a.status}</span></div>
                            <div class="col-md-3 text-end small">${new Date(a.assigned_at).toLocaleDateString()}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displayEvaluators(evaluators) {
            document.getElementById('evaluatorsList').innerHTML = evaluators.map(ev => `
                <div class="card mb-2"><div class="card-body py-2"><strong>${ev.name}</strong> <small>(${ev.email})</small></div></div>
            `).join('');
        }

        function showSection(sectionName) {
            ['assignments', 'works', 'evaluators', 'ready'].forEach(s => {
                document.getElementById(s + 'Section').classList.add('d-none');
            });
            document.getElementById(sectionName + 'Section').classList.remove('d-none');
            
            // Actualizar botones (visual simple)
            document.querySelectorAll('.btn-outline-primary, .btn-outline-secondary, .btn-outline-success').forEach(b => b.classList.remove('active'));
            // Aqu√≠ podr√≠as agregar l√≥gica para a√±adir clase active al bot√≥n presionado
        }

        function getAssignmentStatusInfo(status) {
            const map = {
                'pending': { badge: '<span class="badge bg-warning">Pendiente</span>' },
                'assigned': { badge: '<span class="badge bg-warning text-dark">Asignado</span>' },
                'completed': { badge: '<span class="badge bg-success">Completado</span>' }
            };
            return map[status] || { badge: '<span class="badge bg-secondary">--</span>' };
        }

        function getDaysAgo(d) { return Math.ceil(Math.abs(new Date() - new Date(d)) / (864e5)); }
        
        async function logout() {
            await window.apiClient.logoutUser();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>