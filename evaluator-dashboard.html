<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel del Evaluador - Portal Congreso</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    
    <style>
        .evaluator-container {
            min-height: 100vh;
            background: #f8f9fa;
        }
        
        .stats-card {
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-3px);
        }
        
        .work-item-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        
        .work-item-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .filter-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        
        .evaluation-modal {
            max-width: 800px;
        }
        
        .criteria-item {
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 1rem;
            background: #fafafa;
            transition: all 0.3s ease;
            padding: 1rem;
        }
         .criteria-item:hover {
    background: #f0f8ff;
    border-color: #007bff;
}

.form-range {
    height: 1.5rem;
}

.form-range::-webkit-slider-thumb {
    background: #007bff;
}

.form-range::-moz-range-thumb {
    background: #007bff;
}

.score-summary {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border-radius: 8px;
    padding: 1rem;
}

/* Scroll personalizado para el modal */
.modal-body {
    max-height: 70vh;
    overflow-y: auto;
}

/* Estilos para los badges de puntuaci√≥n */
.score-badge {
    font-size: 0.9rem;
    padding: 0.35rem 0.75rem;
        }      
        .status-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
        }
    </style>
</head>
<body class="evaluator-container">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">
                üéì Congreso Estudiantil "Laboratorios de Ingenier√≠a Qu√≠mica"
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">üë®‚Äçüè´ Panel del Evaluador</span>
                <a class="nav-link" href="index.html">Cerrar Sesi√≥n</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="row">
            <!-- Sidebar de Filtros -->
            <div class="col-lg-3 mb-4">
                <div class="filter-section">
                    <h5 class="mb-3">üîç Filtros</h5>
                    
                    <!-- Filtro por Estado -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Estado</label>
                        <select class="form-select" id="filterStatus">
                            <option value="all">Todos los estados</option>
                            <option value="pending">üìù Pendientes</option>
                            <option value="under_review">üîç En revisi√≥n</option>
                            <option value="accepted_oral">‚úÖ Aceptados (Ponencia)</option>
                            <option value="accepted_poster">‚úÖ Aceptados (P√≥ster)</option>
                            <option value="rejected">‚ùå Rechazados</option>
                        </select>
                    </div>
                    
                    <!-- Filtro por Modalidad -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Modalidad</label>
                        <select class="form-select" id="filterModality">
                            <option value="all">Todas las modalidades</option>
                            <option value="ponencia">üé§ Ponencia</option>
                            <option value="poster">üìä P√≥ster</option>
                        </select>
                    </div>
                    
                    <!-- Filtro por Fecha -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Fecha</label>
                        <select class="form-select" id="filterDate">
                            <option value="all">Todas las fechas</option>
                            <option value="today">Hoy</option>
                            <option value="week">Esta semana</option>
                            <option value="month">Este mes</option>
                        </select>
                    </div>
                    
                    <!-- B√∫squeda por T√≠tulo -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Buscar por t√≠tulo</label>
                        <input type="text" class="form-control" id="searchTitle" placeholder="Ingresa palabras clave...">
                    </div>
                    
                    <!-- Botones de acci√≥n -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="applyFilters()">
                            Aplicar Filtros
                        </button>
                        <button class="btn btn-outline-secondary" onclick="resetFilters()">
                            Limpiar Filtros
                        </button>
                    </div>
                </div>
                
                <!-- Estad√≠sticas R√°pidas -->
                <div class="filter-section">
                    <h5 class="mb-3">üìä Estad√≠sticas</h5>
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="stats-card bg-primary text-white p-3">
                                <h4 id="totalWorks">0</h4>
                                <small>Total</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="stats-card bg-warning text-white p-3">
                                <h4 id="pendingWorks">0</h4>
                                <small>Pendientes</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stats-card bg-info text-white p-3">
                                <h4 id="reviewedWorks">0</h4>
                                <small>Revisados</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stats-card bg-success text-white p-3">
                                <h4 id="completedWorks">0</h4>
                                <small>Completados</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Contenido Principal -->
            <div class="col-lg-9">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Trabajos para Evaluar</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="refreshWorks()">
                            üîÑ Actualizar
                        </button>
                    </div>
                </div>
                
                <!-- Lista de Trabajos -->
                <div id="worksList">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando trabajos...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Evaluaci√≥n -->
    <div class="modal fade" id="evaluationModal" tabindex="-1">
        <div class="modal-dialog modal-lg evaluation-modal">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Evaluar Trabajo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="evaluationContent">
                        <!-- Contenido din√°mico se cargar√° aqu√≠ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/evaluation-assignment.js"></script> 
    <script>
        // Variables globales
        let allWorks = [];
        let currentEvaluationWork = null;
        let evaluationModal = null;

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            evaluationModal = new bootstrap.Modal(document.getElementById('evaluationModal'));
            checkEvaluatorAuth();
            loadEvaluatorWorks();
        });

        // Verificar autenticaci√≥n del evaluador
        async function checkEvaluatorAuth() {
            const { data: { session }, error } = await supabase.auth.getSession();
            if (!session || error) {
                window.location.href = 'login.html';
                return;
            }
            
            // Verificar que el usuario es evaluador
            const user = session.user;
            const profile = await getUserProfile(user.id);
            if (!profile || (profile.user_type !== 'evaluator' && profile.user_type !== 'admin')) {
                alert('No tienes permisos para acceder al panel de evaluador.');
                window.location.href = 'student-dashboard.html';
            }
        }

// Cargar trabajos para evaluaci√≥n - VERSI√ìN MEJORADA CON DIAGN√ìSTICO
// Cargar trabajos asignados al evaluador actual
async function loadEvaluatorWorks() {
    try {
        console.log('üîç Cargando trabajos asignados...');
        
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
            window.location.href = 'login.html';
            return;
        }

        console.log('üë§ Evaluador:', user.id);
        
        // Usar el sistema de asignaciones
        const assignmentSystem = new EvaluationAssignment();
        const assignedWorks = await assignmentSystem.getAssignedWorks(user.id);
        
        console.log('üìã Trabajos asignados:', assignedWorks);
        
        // Transformar datos para compatibilidad
        const works = assignedWorks.map(assignment => ({
            ...assignment.works,
            assignment_id: assignment.id,
            assignment_status: assignment.status
        }));
        
        allWorks = works;
        updateStatistics(works);
        displayAssignedWorks(works);
        
    } catch (error) {
        console.error('‚ùå Error cargando trabajos asignados:', error);
        showError('Error cargando trabajos asignados: ' + error.message);
    }
}


// Mostrar trabajos asignados (nueva funci√≥n)
function displayAssignedWorks(works) {
    const worksContainer = document.getElementById('worksList');
    if (!worksContainer) return;
    
    if (!works || works.length === 0) {
        worksContainer.innerHTML = `
            <div class="text-center py-5">
                <div class="text-muted">
                    <p class="h3">üìù</p>
                    <p class="h5">No hay trabajos asignados</p>
                    <p class="mb-0">Los trabajos se asignan autom√°ticamente cuando los estudiantes los env√≠an</p>
                </div>
            </div>
        `;
        return;
    }
    
    worksContainer.innerHTML = works.map(work => {
        const statusInfo = getStatusInfo(work.status);
        const assignmentStatus = getAssignmentStatusInfo(work.assignment_status);
        const studentName = work.user_profiles ? work.user_profiles.name : 'Estudiante';
        const daysAgo = getDaysAgo(work.submitted_at);
        
        return `
            <div class="work-item-card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="card-title text-primary">${work.title}</h5>
                            <p class="card-text mb-2">
                                <strong>Estudiante:</strong> ${studentName}<br>
                                <strong>Modalidad:</strong> ${work.modality === 'ponencia' ? 'üé§ Ponencia' : 'üìä P√≥ster'}<br>
                                <strong>Enviado:</strong> Hace ${daysAgo} d√≠as<br>
                                <strong>Estado asignaci√≥n:</strong> ${assignmentStatus.badge}
                            </p>
                            <div class="mt-3">
                                <a href="${work.file_url}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                                    üìé Ver Archivo
                                </a>
                                <button class="btn btn-sm btn-success" onclick="openEvaluation('${work.id}')" 
                                    ${work.assignment_status === 'completed' ? 'disabled' : ''}>
                                    ${work.assignment_status === 'completed' ? '‚úÖ Evaluado' : '‚≠ê Evaluar'}
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="viewAssignmentDetails('${work.assignment_id}')">
                                    üìã Detalles Asignaci√≥n
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="status-badge ${statusInfo.class}">
                                ${statusInfo.icon} ${statusInfo.text}
                            </span>
                            <br>
                            <small class="text-muted mt-2 d-block">
                                Asignaci√≥n ID: ${work.assignment_id.substring(0, 8)}...
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Informaci√≥n del estado de asignaci√≥n
function getAssignmentStatusInfo(status) {
    const statusMap = {
        'assigned': { badge: '<span class="badge bg-warning">üìã Asignado</span>', text: 'Asignado' },
        'in_progress': { badge: '<span class="badge bg-info">üîç En Progreso</span>', text: 'En Progreso' },
        'completed': { badge: '<span class="badge bg-success">‚úÖ Completado</span>', text: 'Completado' }
    };
    return statusMap[status] || { badge: '<span class="badge bg-secondary">‚ùì Desconocido</span>', text: 'Desconocido' };
}



        // Actualizar estad√≠sticas
        function updateStatistics(works) {
            const total = works.length;
            const pending = works.filter(work => work.status === 'pending').length;
            const reviewed = works.filter(work => work.status === 'under_review').length;
            const completed = works.filter(work => 
                work.status === 'accepted_oral' || 
                work.status === 'accepted_poster' || 
                work.status === 'rejected'
            ).length;

            document.getElementById('totalWorks').textContent = total;
            document.getElementById('pendingWorks').textContent = pending;
            document.getElementById('reviewedWorks').textContent = reviewed;
            document.getElementById('completedWorks').textContent = completed;
        }

        // Mostrar trabajos en la lista
        function displayWorks(works) {
            const worksContainer = document.getElementById('worksList');
            if (!worksContainer) return;
            
            if (!works || works.length === 0) {
                worksContainer.innerHTML = `
                    <div class="text-center py-5">
                        <div class="text-muted">
                            <p class="h3">üìù</p>
                            <p class="h5">No hay trabajos para evaluar</p>
                            <p class="mb-0">Todos los trabajos han sido evaluados</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            worksContainer.innerHTML = works.map(work => {
                const statusInfo = getStatusInfo(work.status);
                const studentName = work.user_profiles ? work.user_profiles.name : 'Estudiante';
                const daysAgo = getDaysAgo(work.submitted_at);
                
                return `
                    <div class="work-item-card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5 class="card-title text-primary">${work.title}</h5>
                                    <p class="card-text mb-2">
                                        <strong>Estudiante:</strong> ${studentName}<br>
                                        <strong>Modalidad:</strong> ${work.modality === 'ponencia' ? 'üé§ Ponencia' : 'üìä P√≥ster'}<br>
                                        <strong>Enviado:</strong> Hace ${daysAgo} d√≠as
                                    </p>
                                    <div class="mt-3">
                                        <a href="${work.file_url}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                                            üìé Ver Archivo
                                        </a>
                                        <button class="btn btn-sm btn-success" onclick="openEvaluation('${work.id}')">
                                            ‚≠ê Evaluar
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="viewWorkDetails('${work.id}')">
                                            üëÅÔ∏è Ver Detalles
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="status-badge ${statusInfo.class}">
                                        ${statusInfo.icon} ${statusInfo.text}
                                    </span>
                                    <br>
                                    <small class="text-muted mt-2 d-block">
                                        ID: ${work.id.substring(0, 8)}...
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Informaci√≥n del estado
        function getStatusInfo(status) {
            const statusMap = {
                'pending': { class: 'bg-warning text-dark', icon: 'üìù', text: 'Pendiente' },
                'under_review': { class: 'bg-info text-white', icon: 'üîç', text: 'En revisi√≥n' },
                'accepted_oral': { class: 'bg-success text-white', icon: '‚úÖ', text: 'Ponencia' },
                'accepted_poster': { class: 'bg-success text-white', icon: '‚úÖ', text: 'P√≥ster' },
                'rejected': { class: 'bg-danger text-white', icon: '‚ùå', text: 'Rechazado' }
            };
            return statusMap[status] || { class: 'bg-secondary text-white', icon: '‚ùì', text: status };
        }

        // Calcular d√≠as desde el env√≠o
        function getDaysAgo(dateString) {
            const submitted = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - submitted);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        // Abrir evaluaci√≥n
        async function openEvaluation(workId) {
            try {
                const work = allWorks.find(w => w.id === workId);
                if (!work) {
                    alert('Trabajo no encontrado');
                    return;
                }
                
                currentEvaluationWork = work;
                await showEvaluationModal(work);
                
            } catch (error) {
                console.error('Error abriendo evaluaci√≥n:', error);
                alert('Error: ' + error.message);
            }
        }

        // Mostrar modal de evaluaci√≥n ACTUALIZADO
async function showEvaluationModal(work) {
    const studentName = work.user_profiles ? work.user_profiles.name : 'Estudiante';
    
    const modalContent = `
        <div class="evaluation-header mb-4">
            <h4>${work.title}</h4>
            <p class="text-muted mb-0">
                <strong>Estudiante:</strong> ${studentName} | 
                <strong>Modalidad:</strong> ${work.modality === 'ponencia' ? 'Ponencia' : 'P√≥ster'}
            </p>
            <a href="${work.file_url}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">
                üìé Abrir archivo completo
            </a>
        </div>
        
        <div class="alert alert-info">
            <strong>üìã Palabras clave / Keywords:</strong><br>
            ${work.abstract.substring(0, 300)}${work.abstract.length > 300 ? '...' : ''}
        </div>
        
        <form id="evaluationForm">
            <div class="row">
                <div class="col-md-8">
                    <h5 class="mb-3">PARTE 1: CRITERIOS DE EVALUACI√ìN (85%)</h5>
                    
                    <!-- Resumen -->
                    <div class="criteria-item">
                        <label class="form-label fw-semibold">üìÑ Resumen (0-10%)</label>
                        <p class="text-muted small mb-2">Presenta la estructura del contenido del documento y de c√≥mo desarroll√≥ la investigaci√≥n; ¬øQu√© se hizo?, ¬øCu√°l fue el resultado obtenido?</p>
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <input type="range" class="form-range" id="resumenScore" min="0" max="10" step="0.5" value="0">
                            </div>
                            <div class="col-md-4">
                                <span class="badge bg-primary fs-6" id="resumenValue">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Justificaci√≥n -->
                    <div class="criteria-item">
                        <label class="form-label fw-semibold">üéØ Justificaci√≥n (0-10%)</label>
                        <p class="text-muted small mb-2">1. Aborda un problema, demanda o necesidad detectada.<br>2. Expresa con claridad las ideas clave en la formulaci√≥n del problema de investigaci√≥n.</p>
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <input type="range" class="form-range" id="justificacionScore" min="0" max="10" step="0.5" value="0">
                            </div>
                            <div class="col-md-4">
                                <span class="badge bg-primary fs-6" id="justificacionValue">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Objetivos -->
                    <div class="criteria-item">
                        <label class="form-label fw-semibold">üéØ Objetivos (0-15%)</label>
                        <p class="text-muted small mb-2">
                            1. Plantea un objetivo general y espec√≠ficos de manera clara y concisa.<br>
                            2. La redacci√≥n de los objetivos respeta el nivel taxon√≥mico (Bloom).<br>
                            3. El objetivo general se refiere a la soluci√≥n del problema.<br>
                            4. Los objetivos espec√≠ficos detallan los procesos necesarios.
                        </p>
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <input type="range" class="form-range" id="objetivosScore" min="0" max="15" step="0.5" value="0">
                            </div>
                            <div class="col-md-4">
                                <span class="badge bg-primary fs-6" id="objetivosValue">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Introducci√≥n -->
                    <div class="criteria-item">
                        <label class="form-label fw-semibold">üìñ Introducci√≥n (0-10%)</label>
                        <p class="text-muted small mb-2">
                            1. Sustenta el desarrollo de la investigaci√≥n a trav√©s de teor√≠as.<br>
                            2. La informaci√≥n presentada es congruente con los objetivos.<br>
                            3. Sustenta la informaci√≥n con referencias bibliogr√°ficas.
                        </p>
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <input type="range" class="form-range" id="introduccionScore" min="0" max="10" step="0.5" value="0">
                            </div>
                            <div class="col-md-4">
                                <span class="badge bg-primary fs-6" id="introduccionValue">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Metodolog√≠a -->
                    <div class="criteria-item">
                        <label class="form-label fw-semibold">üî¨ Metodolog√≠a (0-10%)</label>
                        <p class="text-muted small mb-2">
                            1. Describe el material, herramientas, equipos utilizados y/o procedimientos.<br>
                            2. El desarrollo es congruente con el contenido tem√°tico.
                        </p>
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <input type="range" class="form-range" id="metodologiaScore" min="0" max="10" step="0.5" value="0">
                            </div>
                            <div class="col-md-4">
                                <span class="badge bg-primary fs-6" id="metodologiaValue">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resultados -->
                    <div class="criteria-item">
                        <label class="form-label fw-semibold">üìä Resultados y an√°lisis (0-15%)</label>
                        <p class="text-muted small mb-2">
                            1. Realiza el tratamiento de datos a trav√©s de m√©todos num√©ricos, gr√°ficos o anal√≠ticos.<br>
                            2. El an√°lisis e interpretaci√≥n de los resultados se realiza mediante una redacci√≥n clara.<br>
                            3. Respeta el formato establecido para presentar tablas, gr√°ficas e im√°genes.
                        </p>
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <input type="range" class="form-range" id="resultadosScore" min="0" max="15" step="0.5" value="0">
                            </div>
                            <div class="col-md-4">
                                <span class="badge bg-primary fs-6" id="resultadosValue">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Conclusiones -->
                    <div class="criteria-item">
                        <label class="form-label fw-semibold">üí° Conclusiones (0-15%)</label>
                        <p class="text-muted small mb-2">Analiza y reflexiona sobre los resultados obtenidos y los relaciona con el cumplimiento de los objetivos.</p>
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <input type="range" class="form-range" id="conclusionesScore" min="0" max="15" step="0.5" value="0">
                            </div>
                            <div class="col-md-4">
                                <span class="badge bg-primary fs-6" id="conclusionesValue">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Referencias -->
                    <div class="criteria-item">
                        <label class="form-label fw-semibold">üìö Referencias (0-5%)</label>
                        <p class="text-muted small mb-2">
                            1. Utiliza bibliograf√≠a actual como: libros, documentos de ingenier√≠a, manuales, revistas cient√≠ficas.<br>
                            2. Respeta el formato APA 7.
                        </p>
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <input type="range" class="form-range" id="referenciasScore" min="0" max="5" step="0.5" value="0">
                            </div>
                            <div class="col-md-4">
                                <span class="badge bg-primary fs-6" id="referenciasValue">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <h5 class="mb-3">PARTE 2: CRITERIOS COMPLEMENTARIOS (10%)</h5>
                    
                    <!-- Factibilidad -->
                    <div class="criteria-item">
                        <label class="form-label fw-semibold">üè≠ Factibilidad y pertinencia (0-2%)</label>
                        <p class="text-muted small mb-2">Integra los conceptos para el dise√±o, operaci√≥n y evaluaci√≥n de procesos qu√≠micos, biol√≥gicos o f√≠sicos.</p>
                        <select class="form-select" id="factibilidadScore">
                            <option value="0">0% - No cumple</option>
                            <option value="1">1% - Parcialmente</option>
                            <option value="2">2% - Totalmente</option>
                        </select>
                    </div>
                    
                    <!-- Innovaci√≥n -->
                    <div class="criteria-item">
                        <label class="form-label fw-semibold">üí° Innovaci√≥n (0-2%)</label>
                        <p class="text-muted small mb-2">Identifica y resuelve problemas que involucran procesos de transformaci√≥n f√≠sica, qu√≠mica y biol√≥gica.</p>
                        <select class="form-select" id="innovacionScore">
                            <option value="0">0% - No innovador</option>
                            <option value="1">1% - Algo innovador</option>
                            <option value="2">2% - Muy innovador</option>
                        </select>
                    </div>
                    
                    <!-- Integraci√≥n -->
                    <div class="criteria-item">
                        <label class="form-label fw-semibold">üîó Integraci√≥n de conocimientos (0-2%)</label>
                        <p class="text-muted small mb-2">Integra conocimientos adquiridos de otras asignaturas de la ciencia y/o la ingenier√≠a.</p>
                        <select class="form-select" id="integracionScore">
                            <option value="0">0% - No integra</option>
                            <option value="1">1% - Integra parcialmente</option>
                            <option value="2">2% - Integra totalmente</option>
                        </select>
                    </div>
                    
                    <!-- Cumplimiento -->
                    <div class="criteria-item">
                        <label class="form-label fw-semibold">üìã Cumplimiento del Programa (0-2%)</label>
                        <p class="text-muted small mb-2">Se apega y cumple con los objetivos del semestre.</p>
                        <select class="form-select" id="cumplimientoScore">
                            <option value="0">0% - No cumple</option>
                            <option value="1">1% - Parcialmente</option>
                            <option value="2">2% - Totalmente</option>
                        </select>
                    </div>
                    
                    <!-- √âtica -->
                    <div class="criteria-item">
                        <label class="form-label fw-semibold">üå± √âtica y valores (0-2%)</label>
                        <p class="text-muted small mb-2">Impacta en las necesidades sociales, ambientales y econ√≥micas bajo marcos normativos.</p>
                        <select class="form-select" id="eticaScore">
                            <option value="0">0% - No considera</option>
                            <option value="1">1% - Considera parcialmente</option>
                            <option value="2">2% - Considera totalmente</option>
                        </select>
                    </div>
                    
                    <!-- Resumen de puntuaci√≥n -->
                    <div class="card mt-4">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">üìä Resumen de Puntuaci√≥n</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <span>Parte 1:</span>
                                <span id="parte1Total">0%</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Parte 2:</span>
                                <span id="parte2Total">0%</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between fw-bold fs-5">
                                <span>Total:</span>
                                <span id="totalScore">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modalidad sugerida -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">üé≠ Modalidad sugerida por el evaluador</label>
                    <select class="form-select" id="modalidadSugerida" required>
                        <option value="">Seleccionar modalidad...</option>
                        <option value="ponencia">Ponencia</option>
                        <option value="poster">P√≥ster</option>
                    </select>
                </div>
            </div>
            
            <!-- Comentarios -->
            <div class="mt-4">
                <label for="comentarios" class="form-label fw-semibold">üí¨ Comentarios del proyecto evaluado</label>
                <textarea class="form-control" id="comentarios" rows="4" 
                          placeholder="Proporciona comentarios detallados, sugerencias de mejora y retroalimentaci√≥n para el estudiante..."></textarea>
            </div>
            
            <!-- Botones -->
            <div class="d-flex justify-content-end gap-2 mt-4">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-success">
                    üì§ Enviar Evaluaci√≥n
                </button>
            </div>
        </form>
    `;
    
    document.getElementById('evaluationContent').innerHTML = modalContent;
    
    // Configurar eventos para los sliders
    setupScoreSliders();
    
    // Configurar env√≠o del formulario
    document.getElementById('evaluationForm').addEventListener('submit', handleEvaluationSubmit);
    
    evaluationModal.show();
}

// Configurar sliders de puntuaci√≥n
function setupScoreSliders() {
    // Configurar todos los sliders de la Parte 1
    const sliders = [
        'resumenScore', 'justificacionScore', 'objetivosScore', 'introduccionScore',
        'metodologiaScore', 'resultadosScore', 'conclusionesScore', 'referenciasScore'
    ];
    
    sliders.forEach(sliderId => {
        const slider = document.getElementById(sliderId);
        const valueDisplay = document.getElementById(sliderId.replace('Score', 'Value'));
        
        slider.addEventListener('input', function() {
            valueDisplay.textContent = `${this.value}%`;
            updateTotalScore();
        });
    });
    
    // Configurar selects de la Parte 2
    const selects = [
        'factibilidadScore', 'innovacionScore', 'integracionScore', 
        'cumplimientoScore', 'eticaScore'
    ];
    
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        select.addEventListener('change', updateTotalScore);
    });
}

// Actualizar puntuaci√≥n total
function updateTotalScore() {
    // Calcular Parte 1
    const parte1Sliders = [
        'resumenScore', 'justificacionScore', 'objetivosScore', 'introduccionScore',
        'metodologiaScore', 'resultadosScore', 'conclusionesScore', 'referenciasScore'
    ];
    
    let parte1Total = 0;
    parte1Sliders.forEach(sliderId => {
        parte1Total += parseFloat(document.getElementById(sliderId).value) || 0;
    });
    
    // Calcular Parte 2
    const parte2Selects = [
        'factibilidadScore', 'innovacionScore', 'integracionScore', 
        'cumplimientoScore', 'eticaScore'
    ];
    
    let parte2Total = 0;
    parte2Selects.forEach(selectId => {
        parte2Total += parseFloat(document.getElementById(selectId).value) || 0;
    });
    
    // Calcular total
    const totalScore = parte1Total + parte2Total;
    
    // Actualizar displays
    document.getElementById('parte1Total').textContent = `${parte1Total.toFixed(1)}%`;
    document.getElementById('parte2Total').textContent = `${parte2Total.toFixed(1)}%`;
    document.getElementById('totalScore').textContent = `${totalScore.toFixed(1)}%`;
    
    return totalScore;
}

// Manejar env√≠o de evaluaci√≥n ACTUALIZADO
async function handleEvaluationSubmit(e) {
    e.preventDefault();
    
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('Usuario no autenticado');
        
        // Validar modalidad sugerida
        const modalidadSugerida = document.getElementById('modalidadSugerida').value;
        if (!modalidadSugerida) {
            alert('Por favor selecciona una modalidad sugerida');
            return;
        }
        
        // Recopilar todos los scores
        const evaluationData = {
            work_id: currentEvaluationWork.id,
            evaluator_id: user.id,
            
            // Parte 1
            resumen_score: parseFloat(document.getElementById('resumenScore').value) || 0,
            justificacion_score: parseFloat(document.getElementById('justificacionScore').value) || 0,
            objetivos_score: parseFloat(document.getElementById('objetivosScore').value) || 0,
            introduccion_score: parseFloat(document.getElementById('introduccionScore').value) || 0,
            metodologia_score: parseFloat(document.getElementById('metodologiaScore').value) || 0,
            resultados_score: parseFloat(document.getElementById('resultadosScore').value) || 0,
            conclusiones_score: parseFloat(document.getElementById('conclusionesScore').value) || 0,
            referencias_score: parseFloat(document.getElementById('referenciasScore').value) || 0,
            
            // Parte 2
            factibilidad_score: parseFloat(document.getElementById('factibilidadScore').value) || 0,
            innovacion_score: parseFloat(document.getElementById('innovacionScore').value) || 0,
            integracion_score: parseFloat(document.getElementById('integracionScore').value) || 0,
            cumplimiento_score: parseFloat(document.getElementById('cumplimientoScore').value) || 0,
            etica_score: parseFloat(document.getElementById('eticaScore').value) || 0,
            
            // Totales y comentarios
            total_score: updateTotalScore(),
            modalidad_sugerida: modalidadSugerida,
            comentarios: document.getElementById('comentarios').value,
            evaluated_at: new Date().toISOString()
        };
        
        console.log('üìä Enviando evaluaci√≥n completa:', evaluationData);
        
        // Validar que se hayan calificado todos los criterios principales
        const parte1Total = evaluationData.resumen_score + evaluationData.justificacion_score + 
                           evaluationData.objetivos_score + evaluationData.introduccion_score +
                           evaluationData.metodologia_score + evaluationData.resultados_score +
                           evaluationData.conclusiones_score + evaluationData.referencias_score;
        
        if (parte1Total === 0) {
            alert('Por favor califica al menos algunos criterios de la Parte 1 antes de enviar');
            return;
        }
        
        // Guardar evaluaci√≥n en Supabase
        const result = await createEvaluation(evaluationData);
        
        if (result.success) {
            // Actualizar estado del trabajo basado en la modalidad sugerida
            let newStatus = 'under_review';
            if (modalidadSugerida === 'ponencia') newStatus = 'accepted_oral';
            if (modalidadSugerida === 'poster') newStatus = 'accepted_poster';
            
            await updateWorkStatus(currentEvaluationWork.id, newStatus);
            
            alert(`‚úÖ Evaluaci√≥n enviada correctamente\nPuntuaci√≥n total: ${evaluationData.total_score.toFixed(1)}%`);
            evaluationModal.hide();
            await loadEvaluatorWorks(); // Recargar la lista
            
        } else {
            throw new Error(result.error);
        }
        
    } catch (error) {
        console.error('Error enviando evaluaci√≥n:', error);
        alert('‚ùå Error: ' + error.message);
    }
}
       
        // Actualizar estado del trabajo
        async function updateWorkStatus(workId, newStatus) {
            const { error } = await supabase
                .from('works')
                .update({ status: newStatus })
                .eq('id', workId);
            
            if (error) throw error;
        }

        // Ver detalles del trabajo
        function viewWorkDetails(workId) {
            const work = allWorks.find(w => w.id === workId);
            if (work) {
                alert(`Detalles del trabajo:\n\nT√≠tulo: ${work.title}\nEstudiante: ${work.user_profiles?.name || 'N/A'}\nModalidad: ${work.modality}\nEstado: ${work.status}\nFecha: ${new Date(work.submitted_at).toLocaleDateString()}`);
            }
        }

        // Aplicar filtros
        function applyFilters() {
            const statusFilter = document.getElementById('filterStatus').value;
            const modalityFilter = document.getElementById('filterModality').value;
            const dateFilter = document.getElementById('filterDate').value;
            const searchText = document.getElementById('searchTitle').value.toLowerCase();
            
            let filteredWorks = allWorks;
            
            // Filtro por estado
            if (statusFilter !== 'all') {
                filteredWorks = filteredWorks.filter(work => work.status === statusFilter);
            }
            
            // Filtro por modalidad
            if (modalityFilter !== 'all') {
                filteredWorks = filteredWorks.filter(work => work.modality === modalityFilter);
            }
            
            // Filtro por fecha
            if (dateFilter !== 'all') {
                const now = new Date();
                filteredWorks = filteredWorks.filter(work => {
                    const workDate = new Date(work.submitted_at);
                    switch (dateFilter) {
                        case 'today':
                            return workDate.toDateString() === now.toDateString();
                        case 'week':
                            const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                            return workDate >= weekAgo;
                        case 'month':
                            const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                            return workDate >= monthAgo;
                        default:
                            return true;
                    }
                });
            }
            
            // Filtro por b√∫squeda de texto
            if (searchText) {
                filteredWorks = filteredWorks.filter(work => 
                    work.title.toLowerCase().includes(searchText)
                );
            }
            
            displayWorks(filteredWorks);
            updateStatistics(filteredWorks);
        }

        // Resetear filtros
        function resetFilters() {
            document.getElementById('filterStatus').value = 'all';
            document.getElementById('filterModality').value = 'all';
            document.getElementById('filterDate').value = 'all';
            document.getElementById('searchTitle').value = '';
            displayWorks(allWorks);
            updateStatistics(allWorks);
        }

        // Refrescar lista
        function refreshWorks() {
            loadEvaluatorWorks();
        }

        // Mostrar error
        function showError(message) {
            const worksContainer = document.getElementById('worksList');
            if (worksContainer) {
                worksContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> ${message}
                        <br><small>Verifica la consola para m√°s detalles</small>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>