<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Evaluador - Congreso</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f4f6f9;
        }

        .work-card {
            border-left: 5px solid #0d6efd;
            transition: transform 0.2s;
        }

        .work-card.live {
            border-left-color: #6f42c1;
        }

        /* Color morado para fase 2 */
        .work-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-tabs .nav-link.active {
            font-weight: bold;
            border-top: 3px solid #0d6efd;
        }

        .score-display {
            font-size: 1.2rem;
            font-weight: bold;
            color: #6f42c1;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">üë®‚Äçüè´ Evaluador</a>
            <button class="btn btn-outline-light btn-sm" onclick="logout()">Salir</button>
        </div>
    </nav>

    <div class="container">
        <!-- Pesta√±as de Fase -->
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="phase1-tab" data-bs-toggle="tab" data-bs-target="#phase1"
                    type="button">
                    üìÑ Fase 1: Documental
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="phase2-tab" data-bs-toggle="tab" data-bs-target="#phase2" type="button">
                    üé§ Fase 2: Presencial (En Vivo)
                </button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">

            <!-- FASE 1 -->
            <div class="tab-pane fade show active" id="phase1">
                <h4 class="mb-3 text-secondary">Evaluaci√≥n de Escritos</h4>
                <div id="phase1List" class="row">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary"></div>
                    </div>
                </div>
            </div>

            <!-- FASE 2 -->
            <div class="tab-pane fade" id="phase2">
                <div class="alert alert-info border-start border-4 border-info">
                    <strong>Instrucciones:</strong> Eval√∫a al alumno durante su presentaci√≥n en vivo. Escala 0 a 5.
                </div>
                <div id="phase2List" class="row">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL FASE 1 (Tu modal anterior, simplificado aqu√≠ para no repetir c√≥digo largo, √∫salo si ya lo tienes) -->
    <!-- ... (Pega aqu√≠ tu modal anterior de evaluaci√≥n documental) ... -->

    <!-- MODAL FASE 2 (NUEVO) -->
    <div class="modal fade" id="liveModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-purple text-white" style="background: #6f42c1;">
                    <h5 class="modal-title">üé§ Evaluaci√≥n Presencial</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h5 id="liveWorkTitle" class="text-primary mb-3"></h5>
                    <form id="liveForm">
                        <!-- R√∫brica 0-5 -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">1. Tono de voz (0-5)</label>
                            <input type="range" class="form-range" min="0" max="5" step="1" oninput="updLive(this)">
                            <div class="text-end fw-bold text-primary">0</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">2. Calidad presentaci√≥n (0-5)</label>
                            <input type="range" class="form-range" min="0" max="5" step="1" oninput="updLive(this)">
                            <div class="text-end fw-bold text-primary">0</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">3. Dominio del contenido (0-5)</label>
                            <input type="range" class="form-range" min="0" max="5" step="1" oninput="updLive(this)">
                            <div class="text-end fw-bold text-primary">0</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">4. Lenguaje corporal (0-5)</label>
                            <input type="range" class="form-range" min="0" max="5" step="1" oninput="updLive(this)">
                            <div class="text-end fw-bold text-primary">0</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">5. Recursos visuales (0-5)</label>
                            <input type="range" class="form-range" min="0" max="5" step="1" oninput="updLive(this)">
                            <div class="text-end fw-bold text-primary">0</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">6. Comunicaci√≥n escrita (0-5)</label>
                            <input type="range" class="form-range" min="0" max="5" step="1" oninput="updLive(this)">
                            <div class="text-end fw-bold text-primary">0</div>
                        </div>

                        <div class="alert alert-secondary text-center">
                            Total: <span id="liveTotal">0</span> / 30
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Comentarios Adicionales</label>
                            <textarea class="form-control" id="liveComments"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="submitLive()">‚úÖ Enviar Calificaci√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/evaluation-assignment.js"></script>
    <script>
        let session = null;
        let currentLiveId = null; // ID Asignaci√≥n Fase 2
        let currentLiveWorkId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            session = await window.apiClient.checkAuth();
            if (!session) return window.location.href = 'login.html';

            loadPhase1();
            loadPhase2();
        });

        // Cargar Fase 1 (C√≥digo existente reutilizado)
        async function loadPhase1() {
            const system = new EvaluationAssignment();
            const assigns = await system.getAssignedWorks(session.user.id);
            const container = document.getElementById('phase1List');

            if (assigns.length === 0) { container.innerHTML = '<p class="text-muted text-center">Sin asignaciones pendientes.</p>'; return; }

            container.innerHTML = assigns.map(a => `
                <div class="col-md-6 mb-3">
                    <div class="card work-card h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="text-primary">${a.works.title}</h5>
                            <small class="text-muted">Fase Documental</small>
                            ${a.status === 'completed' ? '<br><span class="badge bg-secondary">Evaluado</span>' :
                    `<br><button class="btn btn-primary btn-sm mt-2">Evaluar Documento</button>`} 
                            <!-- Nota: Aqu√≠ deber√≠as conectar tu funci√≥n openEvaluation antigua -->
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Cargar Fase 2
        async function loadPhase2() {
            const allLive = await window.apiClient.getLiveAssignments();
            // Filtrar las m√≠as
            const myLive = allLive.filter(a => a.evaluator_id === session.user.id);
            const container = document.getElementById('phase2List');

            if (myLive.length === 0) { container.innerHTML = '<p class="text-muted text-center">No tienes evaluaciones presenciales asignadas a√∫n.</p>'; return; }

            container.innerHTML = myLive.map(a => `
                <div class="col-md-6 mb-3">
                    <div class="card work-card live h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="text-dark" style="color: #6f42c1 !important;">${a.works.title}</h5>
                            <p class="mb-1"><strong>Modalidad:</strong> ${a.works.status.includes('oral') ? 'üé§ Ponencia' : 'üìä Cartel'}</p>
                            <p class="mb-2"><strong>Alumno:</strong> ${a.works.student_name}</p>
                            ${a.status === 'completed'
                    ? '<button class="btn btn-secondary w-100" disabled>‚úÖ Evaluado</button>'
                    : `<button class="btn btn-success w-100" style="background-color: #6f42c1;" onclick="openLive('${a.id}', '${a.works.id}', '${a.works.title}')">‚≠ê Evaluar Presentaci√≥n</button>`
                }
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Abrir Modal Fase 2
        function openLive(assignId, workId, title) {
            currentLiveId = assignId;
            currentLiveWorkId = workId;
            document.getElementById('liveWorkTitle').innerText = title;
            document.getElementById('liveForm').reset();
            document.querySelectorAll('#liveForm .fw-bold.text-primary').forEach(e => e.innerText = '0');
            document.getElementById('liveTotal').innerText = '0';
            new bootstrap.Modal(document.getElementById('liveModal')).show();
        }

        // Actualizar n√∫meros del slider
        function updLive(input) {
            input.nextElementSibling.innerText = input.value;
            // Calcular total
            let sum = 0;
            document.querySelectorAll('#liveForm input[type=range]').forEach(r => sum += parseInt(r.value));
            document.getElementById('liveTotal').innerText = sum;
        }

        // Enviar Fase 2
        async function submitLive() {
            if (!confirm('¬øEnviar calificaci√≥n presencial?')) return;

            const inputs = document.querySelectorAll('#liveForm input[type=range]');
            const scores = Array.from(inputs).map(i => i.value);

            const data = {
                assignment_id: currentLiveId,
                work_id: currentLiveWorkId,
                evaluator_id: session.user.id,
                s1: scores[0], s2: scores[1], s3: scores[2], s4: scores[3], s5: scores[4], s6: scores[5],
                total_score: document.getElementById('liveTotal').innerText,
                comments: document.getElementById('liveComments').value
            };

            const res = await window.apiClient.submitLiveEvaluation(data);
            if (res.success) {
                alert('‚úÖ Evaluaci√≥n guardada');
                location.reload();
            } else {
                alert('Error: ' + res.error);
            }
        }

        async function logout() { await window.apiClient.logoutUser(); window.location.href = 'index.html'; }
    </script>
</body>

</html>